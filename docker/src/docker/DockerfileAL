FROM amazonlinux:2

WORKDIR /opt/corda

# Add packages and clean cache
# Create dirs
# Create corda user
RUN amazon-linux-extras enable corretto8 && \
    yum -y install java-1.8.0-amazon-corretto-devel  && \
    yum -y install bash && \
    yum -y install curl && \
    yum -y install unzip && \
    yum clean all && \
    mkdir -p /opt/corda/cordapps && \
    mkdir -p /opt/corda/persistence && \
    mkdir -p /opt/corda/certificates && \
    mkdir -p /opt/corda/drivers && \
    mkdir -p /opt/corda/logs && \
    mkdir -p /opt/corda/bin && \
    mkdir -p /opt/corda/additional-node-infos && \
    mkdir -p /etc/corda && \
    groupadd corda && \
    useradd corda -g corda -m -d /opt/corda

ENV CORDAPPS_FOLDER="/opt/corda/cordapps" \
    PERSISTENCE_FOLDER="/opt/corda/persistence" \
    CERTIFICATES_FOLDER="/opt/corda/certificates" \
    DRIVERS_FOLDER="/opt/corda/drivers" \
    CONFIG_FOLDER="/etc/corda" \
    MY_P2P_PORT=10200 \
    MY_RPC_PORT=10201 \
    MY_RPC_ADMIN_PORT=10202 \
    PATH=$PATH:/opt/corda/bin \
    JVM_ARGS="-XX:+UseG1GC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap " \
    CORDA_ARGS=""

##CORDAPPS FOLDER
##PERSISTENCE FOLDER
##CERTS FOLDER
##OPTIONAL JDBC DRIVERS FOLDER
##LOG FOLDER
##ADDITIONAL NODE INFOS FOLDER
##CONFIG LOCATION
VOLUME ["/opt/corda/cordapps"] \
       ["/opt/corda/persistence"] \
       ["/opt/corda/certificates"] \
       ["/opt/corda/drivers"] \
       ["/opt/corda/logs"] \
       ["/opt/corda/additional-node-infos"] \
       ["/etc/corda"]

##CORDA JAR
##CONFIG MANIPULATOR JAR
##CONFIG GENERATOR SHELL SCRIPT
##CORDA RUN SCRIPT
##BASE CONFIG FOR GENERATOR
COPY --chown=corda:corda corda.jar /opt/corda/bin/corda.jar
COPY --chown=corda:corda config-exporter.jar /opt/corda/config-exporter.jar
COPY --chown=corda:corda generate-config.sh /opt/corda/bin/config-generator
COPY --chown=corda:corda run-corda.sh /opt/corda/bin/run-corda
COPY --chown=corda:corda starting-node.conf /opt/corda/starting-node.conf

##CHANGE OWNER TO CORDA
##SET EXECUTABLE PERMISSIONS
RUN chown -R corda:corda /opt/corda && \
    chown -R corda:corda /etc/corda && \
    chmod +x /opt/corda/bin/config-generator  && \
    chmod +x /opt/corda/bin/run-corda

USER "corda"
CMD ["run-corda"]